<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>와룡운수 종로 08번 근무현황표</title>
   <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background-color: #f4f4f4; color: #333;
            font-size: 14pt;
        }
        .controls {
            background-color: #fff;
            padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-bottom: 15px;
            display: flex; flex-wrap: wrap; gap: 10px;
            align-items: center;
        }
        .controls label { font-weight: bold; margin-right: 5px; }
        .controls input[type="number"], .controls select {
            padding: 6px;
            border: 1px solid #ddd; border-radius: 4px;
            width: 70px; box-sizing: border-box;
        }
        .controls select.margin-select {
            width: 55px;
            padding: 1px 3px;
            font-size: 0.9em;
        }
        .controls select.action-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }
        .controls select.service-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #17a2b8;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }
        .controls select.work-type-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #ffc107;
            color: #333;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
        }
        .controls select.vehicle-select {
            padding: 8px 15px;
            font-size: 17.5px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            width: auto;
            margin-right: 0;
        }
        .controls input[type="radio"] { margin-left: 10px; }
        .controls button, .controls a.button-link {
            padding: 8px 15px;
            color: white; border: none; border-radius: 4px;
            cursor: pointer; font-size: 17.5px; margin-right: 8px;
            text-decoration: none; display: inline-block; text-align: center; white-space: nowrap;
        }
        .controls button { background-color: #007bff; }
        .controls button:hover { background-color: #0056b3; }
        .controls a.button-link { background-color: #17a2b8; }
        .controls a.button-link:hover { background-color: #138496; }
        .controls button.btn-danger { background-color: #dc3545; }
        .controls button.btn-danger:hover { background-color: #c82333; }
        
        .sunday { }
        .saturday { }
        
        /* 휴일: 날짜와 요일만 굵게 */
        .holiday { color: #333; }
        .holiday td:nth-child(1), .holiday td:nth-child(2) { font-weight: bold; }

        /* 클릭 가능한 헤더 스타일 추가 */
        th.vehicle-header {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        th.vehicle-header:hover {
            background-color: #dbe2ef; /* 마우스 올렸을 때 색상 변경 */
            text-decoration: underline;
            title: "클릭하여 이름 변경";
        }

        .special-day-abbr {
            display: block;
            font-size: 0.5em;
            line-height: 1;
            font-weight: bold;
        }
        .sunday .special-day-abbr { color: #cc0000; }
        .saturday .special-day-abbr { color: #0000cc; }
        .holiday .special-day-abbr { color: #cc0000; }

        #scheduleContainer {
            background-color: white;
            padding: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 20px auto; max-width: 95%; overflow-x: auto;
        }
        table {
            width: 100%;
            min-width: 1200px; border-collapse: collapse;
            margin: 0 auto; font-size: 0.9em; background-color: #fff; table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px; text-align: center;
            vertical-align: top; line-height: 1.1; word-break: keep-all;
            height: 38px; box-sizing: border-box;
            font-size: 13pt;
        }
        th { background-color: #f2f2f2; font-weight: bold; }
        caption {
            font-size: 1.5em;
            margin-bottom: 10px; font-weight: bold;
            color: #333; text-decoration: underline;
        }
        
        .edit-mode {
            position: relative;
            padding: 2px; display: flex; flex-direction: column;
            justify-content: center; height: 100%;
        }
        .edit-mode input {
            width: calc(100% - 8px);
            margin-bottom: 2px;
            padding: 2px; box-sizing: border-box;
        }
        .edit-mode .cell-buttons { display: flex;
            justify-content: space-around; margin-top: 2px; }
        .edit-mode .cell-buttons button {
            padding: 3px 5px;
            font-size: 0.7em; color: white; border: none;
            border-radius: 3px; cursor: pointer; white-space: nowrap;
        }
        .edit-mode .cell-buttons button.btn-fixed { background-color: #007bff; }
        .edit-mode .cell-buttons button.btn-temp { background-color: #ffc107; }
        .edit-mode .cell-buttons button.btn-highlight-am { background-color: #28a745; }
        .edit-mode .cell-buttons button.btn-highlight-pm { background-color: #28a745; }
        .edit-mode button:disabled { cursor: not-allowed; opacity: 0.6; }
        .edit-mode .cell-buttons button.btn-delete { background-color: #dc3545; }

        .name-entry { display: block; margin-top: 2px; margin-bottom: 2px; }
        .name-entry.bold-name { font-weight: bold; }
        .hidden-x { color: white; }
        table th:nth-child(1), table td:nth-child(1),
        table th:nth-child(2), table td:nth-child(2) {
            width: 4%; min-width: 60px;
        }

        @media print {
            @page {
                size: A4;
                margin: 10mm;
                margin-left: var(--print-margin-left, 15mm);
                margin-right: var(--print-margin-right, 5mm);
            }
            body { background-color: white; margin: 0; padding: 0; -webkit-print-color-adjust: exact; }
            .controls { display: none; }
            #scheduleContainer { box-shadow: none; margin: 0; padding: 0; }
            table { width: 100%; min-width: unset; font-size: 0.8em; border: 1px solid #000; table-layout: fixed; }
            th, td { padding: 1px; height: auto; word-break: break-all; }
            table th:nth-child(1), table td:nth-child(1),
            table th:nth-child(2), table td:nth-child(2) { width: 4%; }
        }
        @media screen and (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls input[type="number"], .controls select, .controls button, .controls a.button-link { width: 100%; box-sizing: border-box; margin: 5px 0; }
            .controls select.service-select, .controls select.action-select,
            .controls select.work-type-select, .controls select.vehicle-select { width: 100%; }
            #scheduleContainer { padding: 5px; }
            table { font-size: 0.8em; }
            th, td { padding: 4px; }
        }
    </style>
</head>
<body>
    <div class="controls">
        <label for="yearInput">년도:</label>
        <input type="number" id="yearInput" value="2025">
        <label for="monthInput">월:</label>
        <input type="number" id="monthInput" value="9" onchange="validateMonth(this)">

        <input type="radio" id="option1" name="displayOption" value="1">
        <label for="option1">1일 ~ 15일</label>
        <input type="radio" id="option2" name="displayOption" value="2" checked>
        <label for="option2">16일 ~ 말일</label>

        <button onclick="generateSchedule()">생성</button>
        <button onclick="calculateWorkdays()">08번근무일수계산</button>

        <div style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
            <button onclick="printPage()">인쇄</button>
            <div style="display: flex; flex-direction: column; gap: 2px;">
                <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; height: 18px;">
                    <label for="marginLeftSelect">좌측:</label>
                    <select id="marginLeftSelect" class="margin-select">
                        <option value="0">0</option><option value="10" selected>10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                    </select>
                </div>
                <div style="display: flex; align-items: center; gap: 3px; font-size: 0.9em; height: 18px;">
                    <label for="marginRightSelect">우측:</label>
                    <select id="marginRightSelect" class="margin-select">
                        <option value="0">0</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option>
                    </select>
                </div>
            </div>
        </div>

        <select id="scheduleActionsSelect" class="action-select" onchange="handleScheduleActions()">
            <option value="">근무표 관리 옵션</option>
            <option value="reset">전체 고정 초기화</option>
            <option value="clean_empty">오류 데이터(빈칸) 정리</option>
            <option value="backup">근무자 백업 다운</option>
            <option value="restore">근무자 복구 업로드</option>
        </select>
        <input type="file" id="restoreFile" style="display: none;" onchange="restoreScheduleData(this.files[0])" accept=".json">

        <select id="vehicleSelect" class="vehicle-select">
            <option value="">차량 선택</option>
            <option value="ALL">전체 차량</option>
            </select>
        
        <select id="workTypeSelect" class="work-type-select" onchange="handleWorkTypeChange()">
            <option value="">근무조건 선택</option>
            <option value="normal">3/3 근무</option>
            <option value="biweekly">격주 근무</option>
        </select>

        <select id="serviceSelect" class="service-select" onchange="navigateService()">
            <option value="">노선번호 이동</option>
            <option value="https://waryong2025.github.io/townbus/">08번 배차표</option>
            <option value="https://waryong2025.github.io/timeman/">07번 배차표</option>
            <option value="https://waryong2025.github.io/time">07번 근무현황표</option>
            <option value="https://waryong2025.github.io/mainwaryong">3-1번 근무현황표</option>
            <option value="https://waryong2025.github.io/testtime">3-2번 근무현황표</option>
        </select>
    </div>

    <div id="scheduleContainer">
        <table>
            <caption id="tableCaption">종로 08번 2025년 9월 16일 ~ 말일까지 근무현황표</caption>
            <thead id="scheduleHeader"></thead>
            <tbody id="scheduleBody"></tbody>
        </table>
    </div>

    <div id="workdayModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalTableContainer"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY_COLUMNS = 'jongro08ColumnNames';
        const STORAGE_KEY_FIXED = 'jongro08FixedSchedule';
        const STORAGE_KEY_TEMP = 'jongro08TempSchedule';
        const STORAGE_KEY_WORKTYPE = 'jongro08WorkTypeConfig';

        // 기본 차량 목록
        const DEFAULT_COLUMNS = ['3611', '5510', '3615', '스피아', '3612', '6201', '5504', '5535', '5536', '3614', '비고'];
        
        let VEHICLE_COLUMNS = JSON.parse(localStorage.getItem(STORAGE_KEY_COLUMNS)) || DEFAULT_COLUMNS;

        let fixedScheduleData = JSON.parse(localStorage.getItem(STORAGE_KEY_FIXED)) || {};
        let tempScheduleData = JSON.parse(localStorage.getItem(STORAGE_KEY_TEMP)) || {};
        let workTypeConfig = JSON.parse(localStorage.getItem(STORAGE_KEY_WORKTYPE)) || {};
        let scheduleData = {};

        function getDayName(dayOfWeek) {
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            return days[dayOfWeek];
        }

        function validateMonth(input) {
            let val = parseInt(input.value);
            const yearInput = document.getElementById('yearInput');
            let currentYear = parseInt(yearInput.value);

            if (val > 12) {
                input.value = 1;
                yearInput.value = currentYear + 1;
            } else if (val < 1) {
                input.value = 12;
                yearInput.value = currentYear - 1;
            }
        }

        function isPublicHoliday(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

            const holidays = {
                '2025-01-01': '신정', '2025-01-28': '설날', '2025-01-29': '설날', '2025-01-30': '설날',
                '2025-03-01': '삼일절', '2025-05-05': '어린이날', '2025-05-06': '대체공휴일',
                '2025-06-06': '현충일', '2025-08-15': '광복절', '2025-10-03': '개천절',
                '2025-10-05': '추석', '2025-10-06': '추석', '2025-10-07': '추석', '2025-10-08': '대체공휴일',
                '2025-10-09': '한글날', '2025-12-25': '성탄절',
                '2026-01-01': '신정', '2026-02-17': '설날', '2026-02-18': '설날', '2026-02-19': '설날',
                '2026-03-01': '삼일절', '2026-03-02': '대체공휴일', '2026-05-05': '어린이날',
                '2026-05-24': '부처님오신날', '2026-05-25': '대체공휴일', '2026-06-03': '지방선거',
                '2026-06-06': '현충일', '2026-08-15': '광복절', '2026-09-24': '추석',
                '2026-09-25': '추석', '2026-09-26': '추석', '2026-10-03': '개천절',
                '2026-10-09': '한글날', '2026-12-25': '성탄절'
            };
            return holidays[dateStr] || null;
        }
        
        function getAbbreviation(fullName) {
            if (!fullName) return '';
            return fullName.slice(0, 2);
        }

        function renderCellContent(names) {
            if (!names || names.length === 0) return '';
            return names.map(item => {
                const text = item.text.trim();
                const display = text === '' ? '.' : text;
                const hiddenClass = text === '' ? ' hidden-x' : '';
                return `<span class="name-entry${hiddenClass} ${item.bold ? 'bold-name' : ''}">${display}</span>`;
            }).join('');
        }

        function editCell(cell, colId, dateString, dayOfWeek) {
            if (cell.classList.contains('edit-mode')) return;
            document.querySelectorAll('.edit-mode').forEach(editCell => {
                const prevColId = editCell.dataset.colId;
                const prevDateString = editCell.dataset.dateString;
                const originalNames = (scheduleData[prevDateString] && scheduleData[prevDateString][prevColId]) || [{ text: '', bold: false }, { text: '', bold: false }];
                editCell.classList.remove('edit-mode');
                editCell.innerHTML = renderCellContent(originalNames);
            });
            const currentNames = (scheduleData[dateString] && scheduleData[dateString][colId]) || [{ text: '', bold: false }, { text: '', bold: false }];
            const morningValue = currentNames[0] ? currentNames[0].text : '';
            const afternoonValue = currentNames[1] ? currentNames[1].text : '';
            const isBiweeklySunday = (workTypeConfig[colId] === 'biweekly' && dayOfWeek === 0);

            cell.classList.add('edit-mode');
            cell.dataset.colId = colId;
            cell.dataset.dateString = dateString;
            cell.dataset.dayOfWeek = dayOfWeek;
            cell.innerHTML = `
                <input type="text" class="morning-input" value="${morningValue}" placeholder="오전" data-bold="${currentNames[0].bold}">
                <input type="text" class="afternoon-input" value="${afternoonValue}" placeholder="오후" data-bold="${currentNames[1].bold}">
                <div class="cell-buttons">
                    <button class="btn-fixed" onclick="saveFixedCell(this.parentNode.parentNode)" ${isBiweeklySunday ? 'disabled title="격주 근무 차량은 일요일 고정 저장이 불가능합니다."' : ''}>고정</button>
                    <button class="btn-temp" onclick="saveTempCell(this.parentNode.parentNode)">임시</button>
                    <button class="btn-highlight-am" onclick="highlightCell(this.parentNode.parentNode, 'am')">오전 강조</button>
                    <button class="btn-highlight-pm" onclick="highlightCell(this.parentNode.parentNode, 'pm')">오후 강조</button>
                    <button class="btn-delete" onclick="deleteCell(this.parentNode.parentNode)">삭제</button>
                </div>
            `;
            cell.querySelector('.morning-input').focus();
        }

        function getNamesAndBoldStateFromCell(cellElement) {
            const morningInput = cellElement.querySelector('.morning-input');
            const afternoonInput = cellElement.querySelector('.afternoon-input');
            const morningText = morningInput.value.trim();
            const afternoonText = afternoonInput.value.trim();
            const morningBold = morningInput.dataset.bold === 'true';
            const afternoonBold = afternoonInput.dataset.bold === 'true';

            return [{ text: morningText, bold: morningBold }, { text: afternoonText, bold: afternoonBold }];
        }

        function highlightCell(cellElement, timeOfDay) {
            let inputElement;
            if (timeOfDay === 'am') inputElement = cellElement.querySelector('.morning-input');
            else if (timeOfDay === 'pm') inputElement = cellElement.querySelector('.afternoon-input');
            if (inputElement) {
                const isCurrentlyBold = inputElement.dataset.bold === 'true';
                inputElement.dataset.bold = !isCurrentlyBold;
                inputElement.style.fontWeight = inputElement.dataset.bold === 'true' ? 'bold' : 'normal';
            }
        }

        function saveFixedCell(cellElement) {
            const { colId, dayOfWeek, dateString } = cellElement.dataset;
            const namesToSave = getNamesAndBoldStateFromCell(cellElement);
            const workType = workTypeConfig[colId] || 'normal';

            if (workType === 'biweekly' && dayOfWeek === '0') {
                alert('격주 근무 차량은 일요일 고정 저장이 불가능합니다.');
                return;
            }

            const currentRecurringKey = `${dayOfWeek}-${colId}`;
            if (!fixedScheduleData[currentRecurringKey]) fixedScheduleData[currentRecurringKey] = [];
            fixedScheduleData[currentRecurringKey] = fixedScheduleData[currentRecurringKey].filter(entry => entry.dateString !== dateString);
            fixedScheduleData[currentRecurringKey].push({ dateString: dateString, names: namesToSave });
            
            for (const key in fixedScheduleData) {
                fixedScheduleData[key].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
            }

            localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));
            generateSchedule();
        }

        function saveTempCell(cellElement) {
            const { colId, dateString } = cellElement.dataset;
            const namesToSave = getNamesAndBoldStateFromCell(cellElement);
            if (!tempScheduleData[dateString]) tempScheduleData[dateString] = {};
            tempScheduleData[dateString][colId] = namesToSave;
            localStorage.setItem(STORAGE_KEY_TEMP, JSON.stringify(tempScheduleData));
            generateSchedule();
        }

        function deleteCell(cellElement) {
            const { colId, dayOfWeek, dateString } = cellElement.dataset;

            if (tempScheduleData[dateString]?.[colId]) {
                delete tempScheduleData[dateString][colId];
                if (Object.keys(tempScheduleData[dateString]).length === 0) {
                    delete tempScheduleData[dateString];
                }
                localStorage.setItem(STORAGE_KEY_TEMP, JSON.stringify(tempScheduleData));
                generateSchedule();
                return;
            }

            const recurringKey = `${dayOfWeek}-${colId}`;
            if (fixedScheduleData[recurringKey]) {
                const blankNames = [{ text: '', bold: false }, { text: '', bold: false }];
                
                fixedScheduleData[recurringKey] = fixedScheduleData[recurringKey].filter(entry => entry.dateString !== dateString);
                fixedScheduleData[recurringKey].push({ dateString: dateString, names: blankNames });
                fixedScheduleData[recurringKey].sort((a, b) => new Date(b.dateString) - new Date(a.dateString));
                
                localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));
                generateSchedule();
            }
        }

        function resetAllFixedSchedules() {
            const password = prompt("저장된 모든 고정 근무표를 삭제하시려면 비밀번호를 입력하세요.");
            if (password === "201023") {
                if (confirm("모든 고정 근무표를 삭제합니다. 계속하시겠습니까?")) {
                    fixedScheduleData = {}; localStorage.removeItem(STORAGE_KEY_FIXED);
                    if (confirm("임시 근무표도 함께 초기화하시겠습니까?")) {
                        tempScheduleData = {}; localStorage.removeItem(STORAGE_KEY_TEMP);
                    }
                    workTypeConfig = {}; localStorage.removeItem(STORAGE_KEY_WORKTYPE);
                    generateSchedule(); alert("모든 근무표가 초기화되었습니다.");
                }
            } else { alert("비밀번호 확인 후 신청하세요."); }
        }

        function cleanEmptyFixedSchedules() {
            if (!confirm("이름이 입력되지 않은 '빈 칸'으로 저장된 고정 데이터를 모두 삭제하시겠습니까?\n(11월/12월 데이터가 안 나올 때 해결하는 기능입니다)")) {
                return;
            }

            let changed = false;
            for (const key in fixedScheduleData) {
                const originalLength = fixedScheduleData[key].length;
                fixedScheduleData[key] = fixedScheduleData[key].filter(entry => {
                    const am = entry.names[0].text.trim();
                    const pm = entry.names[1].text.trim();
                    return am !== '' || pm !== ''; 
                });

                if (fixedScheduleData[key].length !== originalLength) changed = true;
                if (fixedScheduleData[key].length === 0) delete fixedScheduleData[key];
            }

            if (changed) {
                localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));
                generateSchedule();
                alert("정리 완료! 11월/12월 근무표를 다시 확인해보세요.");
            } else {
                alert("삭제할 빈 데이터가 발견되지 않았습니다.");
            }
        }

        // 차량번호 변경 (헤더 클릭 시)
        function renameColumn(index) {
            const oldName = VEHICLE_COLUMNS[index];
            const newName = prompt(`현재 [${oldName}] 열의 이름을 무엇으로 변경하시겠습니까?`, oldName);
            
            if (newName !== null && newName.trim() !== "") {
                VEHICLE_COLUMNS[index] = newName.trim();
                localStorage.setItem(STORAGE_KEY_COLUMNS, JSON.stringify(VEHICLE_COLUMNS));
                updateVehicleSelect();
                generateSchedule();
            }
        }

        function updateVehicleSelect() {
            const select = document.getElementById('vehicleSelect');
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.text = '차량 선택';
            select.appendChild(defaultOption);

            const allOption = document.createElement('option');
            allOption.value = 'ALL';
            allOption.text = '전체 차량';
            select.appendChild(allOption);

            VEHICLE_COLUMNS.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.text = col;
                select.appendChild(option);
            });
        }

        function backupScheduleData() {
            const fixedData = localStorage.getItem(STORAGE_KEY_FIXED);
            const tempData = localStorage.getItem(STORAGE_KEY_TEMP);
            const workTypeData = localStorage.getItem(STORAGE_KEY_WORKTYPE);
            const columnData = localStorage.getItem(STORAGE_KEY_COLUMNS); 
            
            const backupData = {
                [STORAGE_KEY_FIXED]: fixedData ? JSON.parse(fixedData) : {},
                [STORAGE_KEY_TEMP]: tempData ? JSON.parse(tempData) : {},
                [STORAGE_KEY_WORKTYPE]: workTypeData ? JSON.parse(workTypeData) : {},
                [STORAGE_KEY_COLUMNS]: columnData ? JSON.parse(columnData) : DEFAULT_COLUMNS
            };
            const jsonString = JSON.stringify(backupData);
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const filename = `jongro08_backup_${year}${month}${day}_${hours}${minutes}${seconds}.json`;
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            alert(`근무표 백업 데이터 파일 (${filename})이 다운로드 폴더에 JSON 파일로 저장됩니다.`);
        }

        function restoreScheduleData(file) {
            const selectElement = document.getElementById('scheduleActionsSelect');
            if (!file) { selectElement.value = ''; return; }
            if (!confirm(`[${file.name}] 파일을 업로드하여 저장된 08번 근무표를 복구하시겠습니까?`)) {
                document.getElementById('restoreFile').value = ''; selectElement.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const loadedData = JSON.parse(event.target.result);
                    const fixedKey = STORAGE_KEY_FIXED; const tempKey = STORAGE_KEY_TEMP; const workTypeKey = STORAGE_KEY_WORKTYPE; const colKey = STORAGE_KEY_COLUMNS;
                    
                    let loadedFixed = loadedData[fixedKey]; 
                    let loadedTemp = loadedData[tempKey]; 
                    let loadedWorkType = loadedData[workTypeKey];
                    let loadedColumns = loadedData[colKey];

                    if (!loadedFixed && !loadedTemp) { loadedFixed = loadedData.fixedSchedule; loadedTemp = loadedData.tempSchedule; }
                    if (!loadedWorkType) loadedWorkType = {};
                    if (!loadedColumns) loadedColumns = DEFAULT_COLUMNS;

                    if (!loadedFixed || !loadedTemp) { alert('파일 형식이 올바르지 않습니다.'); return; }

                    fixedScheduleData = loadedFixed; 
                    tempScheduleData = loadedTemp; 
                    workTypeConfig = loadedWorkType;
                    VEHICLE_COLUMNS = loadedColumns;

                    localStorage.setItem(STORAGE_KEY_FIXED, JSON.stringify(fixedScheduleData));
                    localStorage.setItem(STORAGE_KEY_TEMP, JSON.stringify(tempScheduleData));
                    localStorage.setItem(STORAGE_KEY_WORKTYPE, JSON.stringify(workTypeConfig));
                    localStorage.setItem(STORAGE_KEY_COLUMNS, JSON.stringify(VEHICLE_COLUMNS));
                    
                    updateVehicleSelect();
                    generateSchedule();
                    alert(`[${file.name}] 복구 완료.`);
                } catch (e) { alert('오류 발생: 파일 손상.'); console.error(e); }
                document.getElementById('restoreFile').value = ''; selectElement.value = '';
            };
            reader.readAsText(file);
        }

        function generateSchedule() {
            const monthInput = document.getElementById('monthInput'); validateMonth(monthInput);
            const year = parseInt(document.getElementById('yearInput').value);
            const month = parseInt(monthInput.value);
            const selectedOption = document.querySelector('input[name="displayOption"]:checked').value;
            const scheduleHeader = document.getElementById('scheduleHeader');
            const scheduleBody = document.getElementById('scheduleBody');
            const tableCaption = document.getElementById('tableCaption');
            
            // 헤더 생성 시 onclick 이벤트 추가
            const headerHTML = `
                <tr>
                    <th style="width: 4%;">월일</th>
                    <th style="width: 4%;">요일</th>
                    ${VEHICLE_COLUMNS.map((c, index) => 
                        `<th class="vehicle-header" onclick="renameColumn(${index})" title="클릭하여 이름 변경">${c}</th>`
                    ).join('')}
                </tr>`;
                
            scheduleHeader.innerHTML = headerHTML; scheduleBody.innerHTML = '';
            const startDate = new Date(year, month - 1, selectedOption === '1' ? 1 : 16);
            const endDate = (selectedOption === '1') ? new Date(year, month - 1, 15) : new Date(year, month, 0);
            tableCaption.textContent = `종로 08번 ${year}년 ${month}월 ${startDate.getDate()}일 ~ ${endDate.getDate()}일까지 근무현황표`;
            scheduleData = {};

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateString = d.toISOString().slice(0, 10);
                const dayOfWeek = d.getDay();
                const holidayName = isPublicHoliday(d);
                const currentYear = d.getFullYear(); 

                let rowClass = '', specialFullName = null;
                if (holidayName) { rowClass = 'holiday'; specialFullName = holidayName; }
                else if (dayOfWeek === 0) { rowClass = 'sunday'; specialFullName = '일요일'; }
                else if (dayOfWeek === 6) { rowClass = 'saturday'; specialFullName = '토요일'; }
                const dayNameHtml = getDayName(dayOfWeek);
                let specialNameHtml = '';
                if (specialFullName) specialNameHtml = `<span class="special-day-abbr">${getAbbreviation(specialFullName)}</span>`;

                let cellsContent = {};
                VEHICLE_COLUMNS.forEach(colId => {
                    let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                    if (tempScheduleData[dateString] && tempScheduleData[dateString][colId]) {
                        appliedNames = tempScheduleData[dateString][colId];
                    } else {
                        const recurringKey = `${dayOfWeek}-${colId}`;
                        if (fixedScheduleData[recurringKey]) {
                            let anchorEntry = null;
                            for (const entry of fixedScheduleData[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) { anchorEntry = entry; break; }
                            }
                            if (anchorEntry) {
                                const workType = workTypeConfig[colId] || 'normal';
                                if (workType === 'biweekly' && dayOfWeek !== 0) {
                                    const anchorDate = new Date(anchorEntry.dateString);
                                    const currentDate = new Date(dateString);
                                    anchorDate.setHours(0, 0, 0, 0); currentDate.setHours(0, 0, 0, 0);
                                    const msInDay = 24 * 60 * 60 * 1000;
                                    const diffInDays = Math.round((currentDate.getTime() - anchorDate.getTime()) / msInDay);
                                    const weekDifference = Math.floor(diffInDays / 7);
                                    if (weekDifference % 2 === 1) appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                    else appliedNames = anchorEntry.names;
                                } else { appliedNames = anchorEntry.names; }
                            }
                        }
                    }
                    
                    // 원본 오염 방지용 복사
                    appliedNames = appliedNames.map(item => ({ ...item }));

                    // [수정됨] 2026년부터 오부장/오인중 근무 로직 적용
                    // 조건: 2026년 이상이고 공휴일(법정/대체)인 경우에만 휴무 처리
                    // (토요일은 holidayName이 없으므로 삭제되지 않고 근무 유지됨)
                    if (currentYear >= 2026 && holidayName) {
                        const targetNames = ['오부장', '오인중'];
                        if (targetNames.includes(appliedNames[0].text.trim())) {
                            appliedNames[0] = { text: '', bold: false };
                        }
                        if (targetNames.includes(appliedNames[1].text.trim())) {
                            appliedNames[1] = { text: '', bold: false };
                        }
                    }

                    cellsContent[colId] = appliedNames;
                });
                scheduleData[dateString] = cellsContent;
                const dataCellsHTML = VEHICLE_COLUMNS.map(colId =>
                    `<td onclick="editCell(this, '${colId}', '${dateString}', ${dayOfWeek})">${renderCellContent(cellsContent[colId])}</td>`
                ).join('');
                scheduleBody.insertAdjacentHTML('beforeend', `<tr class="${rowClass}"><td>${d.getDate()}</td><td>${dayNameHtml}${specialNameHtml}</td>${dataCellsHTML}</tr>`);
            }
        }

        function calculateWorkdays() {
            const year = parseInt(document.getElementById('yearInput').value);
            const month = parseInt(document.getElementById('monthInput').value);
            const workdayCounts = {}; const shiftCounts = {};
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateString = d.toISOString().slice(0, 10);
                const dayOfWeek = d.getDay();
                const holidayName = isPublicHoliday(d); 
                const currentYear = d.getFullYear();

                VEHICLE_COLUMNS.forEach(colId => {
                    // 비고란 처리: 이름이 '비고'일 때만 계산 제외
                    if (colId === '비고') return;
                    
                    let appliedNames = [{ text: '', bold: false }, { text: '', bold: false }];
                    if (tempScheduleData[dateString] && tempScheduleData[dateString][colId]) appliedNames = tempScheduleData[dateString][colId];
                    else {
                        const recurringKey = `${dayOfWeek}-${colId}`;
                        if (fixedScheduleData[recurringKey]) {
                            let anchorEntry = null;
                            for (const entry of fixedScheduleData[recurringKey]) {
                                if (new Date(dateString) >= new Date(entry.dateString)) { anchorEntry = entry; break; }
                            }
                            if (anchorEntry) {
                                const workType = workTypeConfig[colId] || 'normal';
                                if (workType === 'biweekly' && dayOfWeek !== 0) {
                                    const anchorDate = new Date(anchorEntry.dateString);
                                    const currentDate = new Date(dateString);
                                    anchorDate.setHours(0, 0, 0, 0); currentDate.setHours(0, 0, 0, 0);
                                    const weekDifference = Math.floor(Math.round((currentDate.getTime() - anchorDate.getTime()) / 86400000) / 7);
                                    if (weekDifference % 2 === 1) appliedNames = [anchorEntry.names[1], anchorEntry.names[0]];
                                    else appliedNames = anchorEntry.names;
                                } else appliedNames = anchorEntry.names;
                            }
                        }
                    }

                    // 원본 오염 방지용 복사
                    appliedNames = appliedNames.map(item => ({ ...item }));

                    // [수정됨] 2026년부터 오부장/오인중 근무일수 계산 시 공휴일 제외 로직
                    if (currentYear >= 2026 && holidayName) {
                        const targetNames = ['오부장', '오인중'];
                        if (targetNames.includes(appliedNames[0].text.trim())) {
                            appliedNames[0] = { text: '', bold: false };
                        }
                        if (targetNames.includes(appliedNames[1].text.trim())) {
                            appliedNames[1] = { text: '', bold: false };
                        }
                    }

                    appliedNames.forEach((item, index) => {
                        const name = item.text.trim();
                        if (name !== '') {
                            if (!shiftCounts[name]) shiftCounts[name] = { 오전: 0, 오후: 0 };
                            if (index === 0) shiftCounts[name].오전++; else shiftCounts[name].오후++;
                            if (!workdayCounts[name]) workdayCounts[name] = 0; workdayCounts[name]++;
                        }
                    });
                });
            }
            const combinedData = Object.keys(workdayCounts).map(name => ({
                name: name, workdays: workdayCounts[name],
                morningShifts: shiftCounts[name]?.오전 || 0, afternoonShifts: shiftCounts[name]?.오후 || 0
            })).sort((a, b) => b.workdays - a.workdays);
            
            const tableHTML = `<table style="width: 100%; border-collapse: collapse;"><thead><tr><th style="border:1px solid #ddd;padding:8px">이름</th><th style="border:1px solid #ddd;padding:8px">오전</th><th style="border:1px solid #ddd;padding:8px">오후</th><th style="border:1px solid #ddd;padding:8px">총일수</th></tr></thead><tbody>${combinedData.map(d => `<tr><td style="border:1px solid #ddd;padding:8px;text-align:center">${d.name}</td><td style="border:1px solid #ddd;padding:8px;text-align:center">${d.morningShifts}</td><td style="border:1px solid #ddd;padding:8px;text-align:center">${d.afternoonShifts}</td><td style="border:1px solid #ddd;padding:8px;text-align:center">${d.workdays}</td></tr>`).join('')}</tbody></table>`;
            const w = window.open('', '_blank', 'width=600,height=400');
            w.document.write(`<html><head><title>${year}년 ${month}월 근무일수</title><style>body{font-family:Arial,sans-serif;margin:20px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:10px;text-align:center}th{background:#f2f2f2}</style></head><body><h3>${year}년 ${month}월 근무일수</h3>${tableHTML}<button onclick="window.print()" style="margin:20px auto;display:block;padding:10px 20px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer">인쇄</button></body></html>`);
            w.document.close();
        }

        function printPage() {
            const editCell = document.querySelector('.edit-mode');
            if (editCell) {
                const { colId, dateString } = editCell.dataset;
                const originalNames = scheduleData[dateString]?.[colId] || [{ text: '', bold: false }, { text: '', bold: false }];
                editCell.classList.remove('edit-mode');
                editCell.innerHTML = renderCellContent(originalNames);
            }
            const marginLeft = document.getElementById('marginLeftSelect').value;
            const marginRight = document.getElementById('marginRightSelect').value;
            document.documentElement.style.setProperty('--print-margin-left', `${marginLeft}mm`);
            document.documentElement.style.setProperty('--print-margin-right', `${marginRight}mm`);
            
            const originalTitle = document.title;
            const captionText = document.getElementById('tableCaption').textContent;
            const matches = captionText.match(/(\d{4})년 (\d{1,2})월 (\d{1,2})일 ~ (\d{1,2})일/);
            document.title = matches ? `종로08번 ${matches[1]}-${matches[2].padStart(2,'0')} (${matches[3].padStart(2,'0')}일-${matches[4].padStart(2,'0')}일)` : "종로08번 근무현황표";
            
            const handleAfterPrint = () => {
                document.title = originalTitle;
                document.documentElement.style.removeProperty('--print-margin-left');
                document.documentElement.style.removeProperty('--print-margin-right');
                window.removeEventListener('afterprint', handleAfterPrint);
            };
            window.addEventListener('afterprint', handleAfterPrint);
            window.print();
        }

        function handleScheduleActions() {
            const select = document.getElementById('scheduleActionsSelect');
            if (select.value === 'reset') resetAllFixedSchedules();
            else if (select.value === 'clean_empty') cleanEmptyFixedSchedules();
            else if (select.value === 'backup') backupScheduleData();
            else if (select.value === 'restore') document.getElementById('restoreFile').click();
            select.value = '';
        }

        function handleWorkTypeChange() {
            const vehicleSelect = document.getElementById('vehicleSelect');
            const workTypeSelect = document.getElementById('workTypeSelect');
            const target = vehicleSelect.value;
            const workType = workTypeSelect.value;

            if (!target || !workType) return;

            const targets = target === 'ALL' 
                ? VEHICLE_COLUMNS.filter(v => !isNaN(v))
                : [target];

            const typeName = workType === 'normal' ? '3/3 근무' : '격주 근무';
            
            if (confirm(`선택된 차량 [${target === 'ALL' ? '전체 차량' : target}]의 근무형태를 [${typeName}]로 변경하시겠습니까?`)) {
                targets.forEach(v => {
                    workTypeConfig[v] = workType;
                });
                localStorage.setItem(STORAGE_KEY_WORKTYPE, JSON.stringify(workTypeConfig));
                alert("설정이 저장되었습니다. '고정' 버튼을 사용하여 근무자를 저장하면 해당 날짜부터 로테이션이 적용됩니다.");
                generateSchedule();
            }
            
            vehicleSelect.value = '';
            workTypeSelect.value = '';
        }

        function navigateService() {
            const selectElement = document.getElementById('serviceSelect');
            if (selectElement.value) { window.open(selectElement.value, '_blank'); selectElement.value = ''; }
        }

        function closeModal() { document.getElementById('workdayModal').style.display = 'none'; }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('yearInput').value = today.getFullYear();
            document.getElementById('monthInput').value = today.getMonth() + 1;
            if (today.getDate() <= 15) document.getElementById('option1').checked = true;
            else document.getElementById('option2').checked = true;
            
            updateVehicleSelect(); // 초기 드롭다운 생성
            generateSchedule();
        });
    </script>
</body>
</html>
